# Ante un push, descarga el codigo, hace build y reinicia el proyecto.

name: Build.js CI


on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
      NEXTAUTH_URL: ${{ vars.NEXTAUTH_URL }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_RTE: ${{ vars.RESEND_RTE }}
      URL_WHATSAPP: ${{ vars.URL_WHATSAPP }}
      TOKEN_WHATSAPP: ${{ secrets.TOKEN_WHATSAPP }} 
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} on an self hosted server !"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Instalar PM2.
        run: npm install -g pm2
      - name: Detener App.
        run: pm2 stop "Consultorio App"
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Instalar Paquetes,
        run: npm ci
      - name: Build de la App.
        run: npm run build --if-present
      - name: Iniciar App.
        run: npm run pm2-start
      - run: echo "üçè This job's status is ${{ job.status }}. Ok "
      - name: Enviar Whatsapp de Confirmacion.
        run: npm run okBuild

